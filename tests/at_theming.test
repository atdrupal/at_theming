<?php

class At_Theming_TestCase extends DrupalWebTestCase {
  public function getInfo() {
    return array(
      'name' => 'AT Theming',
      'description' => 'Make sure at_theming module is working correctly.',
      'group' => 'AT Theming',
    );
  }

  protected function setUp() {
    parent::setUp('atest_theming');
  }

  public function testViewRenderClass() {
    $template_file = drupal_get_path('module', 'atest_theming') . '/templates/users.tpl.php';
    $view_name = 'atest_theming_user';
    $display_id = 'default';

    $class = 'Drupal\at_theming\ViewRender';
    $file1 = _at_autoload_get_file($class);
    $file2 = _at_autoload_get_file_static($class);
    $cached_at_modules = at_modules();
    $no_cached_at_modules[] = $base_module = 'at_base';
    foreach (system_list('module_enabled') as $name => $project) {
      if (isset($project->info['dependencies'])) {
        if (in_array($base_module, $project->info['dependencies'])) {
          $no_cached_at_modules[] = $name;
        }
      }
    }

    print_r(array(
      'DEBUG',
      'apc' => function_exists('apc_clear_cache'),
      'class' => $class,
      '_at_autoload_get_file' => $file1,
      '_at_autoload_get_file_static' => $file2,
      $cached_at_modules,
      $no_cached_at_modules,
      system_list('module_enabled'),
      cache_get('at_base:modules:at_base', 'cache_bootstrap')
    ));

    $output = at_id(new \Drupal\at_theming\ViewRender($template_file, $view_name, $display_id))->render();
    $this->assertTrue(preg_match('/UID: \d+/', $output));
  }

  public function testTwigRender() {
    $template_file = drupal_get_path('module', 'atest_theming') . '/templates/hello.twig';
    $output = at_theming_render_template($template_file, array('name' => 'Andy Truong'));
    $this->assertTrue(strpos($output, 'Hello Andy Truong') !== FALSE);

    // with drupalView filter
    $template_file = '@atest_theming/twig/views/simple.html.twig';
    $output = at_theming_render_template($template_file);
    $this->assertTrue(strpos($output, '>1</a>') !== FALSE);

    // with drupalBlock filter
    $template_file = '@atest_theming/twig/block.html.twig';
    $output = at_theming_render_template($template_file);
    $this->assertTrue(strpos($output, 'Powered by') !== FALSE);
  }
}
